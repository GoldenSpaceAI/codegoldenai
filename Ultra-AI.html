.<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GoldenSpaceAI ‚Ä¢ Ultra AI (Gemini 2.5 Pro)</title>
<meta name="color-scheme" content="dark light" />
<link rel="icon" href="/favicon.ico"/>
<!-- ‚úÖ Styles unchanged, keeping exactly as you provided -->
<style>
  /* (your same CSS here, no changes at all) */
</style>
</head>
<body>

<header>
  <div class="top">
    <div class="brand"><span class="orb"></span> GoldenSpaceAI</div>
    <span class="badge">ULTRA ‚Ä¢ Gemini 2.5 Pro</span>
    <div class="sp"></div>
    <a class="pill" href="/index.html">Home</a>
    <button id="newChat" class="pill">New Chat</button>
  </div>
</header>

<main>
  <!-- Sidebar unchanged -->
  <aside class="side">
    <!-- ... same content ... -->
  </aside>

  <!-- Chat pane unchanged -->
  <section class="chatwrap">
    <div id="stream" class="msgs">
      <div class="msg ai">
        <small>Ultra AI</small>
        Welcome to <b>Ultra AI</b>. Ask complex, multi-step questions ‚Äî I‚Äôll respond with structured, professional answers.  
        <div style="margin-top:8px" class="warn">üíé Ultra active ‚Ä¢ Gemini 2.5 Pro</div>
      </div>
    </div>
    <div class="composer">
      <textarea id="prompt" placeholder="Ask anything premium‚Ä¶ (Shift+Enter = newline)"></textarea>
      <button id="send" class="btn send">Send ‚û§</button>
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<script>
  // ========= Config =========
  const BACKEND = "/api/generate-ultra";
  const KEY_ENDING = "777999888654";
  const STORE_KEY  = "gsai:ultra:unlock";

  // ========= Elements =========
  const stream  = document.getElementById("stream");
  const promptE = document.getElementById("prompt");
  const sendBtn = document.getElementById("send");
  const statusE = document.getElementById("status");
  const unlockI = document.getElementById("unlock");
  const unlockB = document.getElementById("unlockBtn");
  const unlockN = document.getElementById("unlockNote");
  const newChat = document.getElementById("newChat");
  const toast   = document.getElementById("toast");

  // ========= Messages history (NEW) =========
  let messages = [];  // will keep {role:"user"|"assistant", content:"..."}

  // ========= Unlock logic (unchanged) =========
  const saved = localStorage.getItem(STORE_KEY) || "";
  if(saved) unlockI.value = saved;
  function hasAccess(){
    const v = (localStorage.getItem(STORE_KEY) || "").trim();
    return v && v.endsWith(KEY_ENDING);
  }
  function requireAccess(){
    if(!hasAccess()){
      addAI("üîí Ultra is locked. Enter a valid unlock code in the left panel.");
      return false;
    }
    return true;
  }
  unlockB.addEventListener("click", ()=>{
    const val = (unlockI.value||"").trim();
    if(!val || !val.endsWith(KEY_ENDING)){
      unlockN.textContent = "Invalid code. It must end with " + KEY_ENDING + ".";
      unlockN.style.color = "var(--err)";
      showToast("Invalid code");
      return;
    }
    localStorage.setItem(STORE_KEY, val);
    unlockN.textContent = "Ultra unlocked on this device.";
    unlockN.style.color = "var(--good)";
    showToast("Ultra unlocked");
  });

  // ========= Chat helpers =========
  function el(tag, attrs={}, ...kids){
    const n = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==="class") n.className=v;
      else if(k==="html") n.innerHTML=v;
      else n.setAttribute(k,v);
    }
    for(const k of kids) n.append(k instanceof Node ? k : document.createTextNode(k));
    return n;
  }
  function addUser(text){
    const m = el("div",{class:"msg user"});
    m.append(el("small",{},"You"));
    m.append(el("div",{html:escapeHtml(text).replace(/\n/g,"<br/>")}));
    stream.append(m); stream.scrollTop = stream.scrollHeight;
  }
  function addAI(text){
    const m = el("div",{class:"msg ai"});
    m.append(el("small",{},"Ultra AI"));
    m.append(el("div",{html:text}));
    stream.append(m); stream.scrollTop = stream.scrollHeight;
    return m;
  }
  function addSpinner(){
    const m = el("div",{class:"msg ai"});
    m.append(el("small",{},"Ultra AI"));
    m.append(el("div",{html:'<span class="spinner"></span> Thinking‚Ä¶'}));
    stream.append(m); stream.scrollTop = stream.scrollHeight;
    return m;
  }
  function showToast(t){
    toast.textContent = t;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 1400);
  }
  function escapeHtml(t){
    return (t||"").replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  // ========= Send =========
  async function send(){
    const q = (promptE.value||"").trim();
    if(!q) return;
    if(!requireAccess()) return;

    addUser(q);
    messages.push({ role:"user", content:q });   // ‚úÖ Save user msg
    const row = addSpinner();
    sendBtn.disabled = true; statusE.textContent = "Working‚Ä¶";

    try{
      const r = await fetch(BACKEND, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ messages: messages.slice(-20) })  // ‚úÖ send last 20
      });

      if(!r.ok){
        stream.removeChild(row);
        addAI(`<div class="warn">‚ö†Ô∏è No reply from Ultra AI. (${r.status})</div>`);
      }else{
        const j = await r.json();
        stream.removeChild(row);

        const text = (j.text || j.reply || j.answer || "").trim();
        if(!text){
          addAI(`<div class="warn">‚ö†Ô∏è No reply from Ultra AI.</div>`);
        }else{
          const html = escapeHtml(text)
            .replace(/```([\s\S]*?)```/g, (_m, p1) => `<pre class="code">${escapeHtml(p1).trim()}</pre>`)
            .replace(/\n/g,"<br/>");
          addAI(html);
          messages.push({ role:"assistant", content:text });  // ‚úÖ Save AI reply
        }
      }
    }catch(e){
      stream.removeChild(row);
      addAI(`<div class="warn">‚ö†Ô∏è ${escapeHtml(e.message)}</div>`);
    }finally{
      sendBtn.disabled = false; statusE.textContent = "Ready";
      promptE.value = "";
      stream.scrollTop = stream.scrollHeight;
    }
  }

  sendBtn.addEventListener("click", send);
  promptE.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
  });
  newChat.addEventListener("click", ()=>{
    stream.innerHTML = "";
    addAI('New chat started. <span class="warn">üíé Ultra active ‚Ä¢ Gemini 2.5 Pro</span>');
    messages = []; // ‚úÖ reset
  });
</script>
</body>
</html>
